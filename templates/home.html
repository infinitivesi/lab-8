{% extends "base.html" %}

{% block title %}Головна{% endblock %}

{% block content %}
<section class="text-center mb-8">
    <h1 class="text-4xl font-extrabold mb-3">Ласкаво просимо</h1>
    <p class="text-lg text-gray-700 mb-4">Швидкий доступ до курсів, магазин та демонстрації API.</p>

    <!-- Search -->
    <div class="max-w-2xl mx-auto flex items-center gap-2">
        <input id="homeSearch" type="search" placeholder="Пошук товарів за назвою..." class="flex-1 px-4 py-3 rounded-lg shadow focus:outline-none" />
        <button id="searchBtn" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">Пошук</button>
        <button id="clearSearch" class="bg-gray-200 text-gray-800 px-3 py-3 rounded-lg ml-1">Очистити</button>
    </div>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Featured products -->
    <div class="col-span-2 bg-white p-4 rounded-lg shadow">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold">Рекомендовані товари</h2>
            <a href="{{ url_for('shop.shop') }}" class="text-sm text-blue-600 hover:underline">Всі товари →</a>
        </div>
        <div id="featured" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- populated by JS -->
            <div class="col-span-full text-center text-gray-500">Завантаження...</div>
        </div>
    </div>

    <!-- Quick actions + Latest feedback -->
    <aside class="bg-white p-4 rounded-lg shadow">
        <div class="mb-6">
            <h3 class="font-bold mb-2">Швидкі дії</h3>
            <div class="flex flex-col gap-2">
                <a href="{{ url_for('shop.shop') }}" class="block text-center bg-green-500 text-white px-3 py-2 rounded">Перейти в магазин</a>
                <a href="{{ url_for('shop.cart') }}" class="block text-center bg-indigo-500 text-white px-3 py-2 rounded">Мій кошик</a>
                <a href="{{ url_for('feedback.feedback') }}" class="block text-center bg-yellow-500 text-white px-3 py-2 rounded">Залишити відгук</a>
                <a href="{{ url_for('api_demo') }}" class="block text-center bg-gray-800 text-white px-3 py-2 rounded">API Demo</a>
            </div>
        </div>

        <div>
            <h3 class="font-bold mb-2">Останні відгуки</h3>
            <div id="latestFeedback" class="space-y-3 text-sm text-gray-700">
                <div class="text-center text-gray-500">Завантаження...</div>
            </div>
        </div>
    </aside>
</section>

<!-- Search results -->
<section id="searchResults" class="mb-8 hidden">
    <h2 class="text-2xl font-bold mb-3">Результати пошуку</h2>
    <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const API = {
        products: '/api/v1/products',
        feedback: '/api/v1/feedback',
    };

    const featuredEl = document.getElementById('featured');
    const latestFeedbackEl = document.getElementById('latestFeedback');
    const searchInput = document.getElementById('homeSearch');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearSearch');
    const searchResults = document.getElementById('searchResults');
    const resultsGrid = document.getElementById('resultsGrid');

    async function fetchFeatured() {
        try {
            const r = await fetch(API.products);
            const json = await r.json();
            const items = (json.data && Array.isArray(json.data)) ? json.data.slice(0,6) : [];
            if (!items.length) {
                featuredEl.innerHTML = '<div class="col-span-full text-gray-500">Товари відсутні</div>';
                return;
            }
            featuredEl.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-3 rounded border';
                card.innerHTML = `
                    <img src="${item.image || 'https://picsum.photos/seed/'+item.id+'/400/250'}" alt="${item.name}" class="w-full h-40 object-cover rounded mb-2">
                    <h4 class="font-semibold">${item.name}</h4>
                    <p class="text-sm text-gray-600">${item.price ? item.price + ' грн' : 'ціна не вказана'}</p>
                `;
                featuredEl.appendChild(card);
            });
        } catch (e) {
            featuredEl.innerHTML = '<div class="col-span-full text-red-600">Помилка завантаження товарів</div>';
            console.error(e);
        }
    }

    async function fetchLatestFeedback() {
        try {
            const r = await fetch(API.feedback);
            const json = await r.json();
            const items = (json.data && Array.isArray(json.data)) ? json.data.slice(0,5) : [];
            if (!items.length) {
                latestFeedbackEl.innerHTML = '<div class="text-gray-500">Відгуків поки немає</div>';
                return;
            }
            latestFeedbackEl.innerHTML = '';
            items.forEach(f => {
                const el = document.createElement('div');
                el.className = 'p-2 border rounded';
                el.innerHTML = `<strong>${f.name}</strong> <div class="text-xs text-gray-500">${f.email}</div><div class="mt-1">${f.message}</div>`;
                latestFeedbackEl.appendChild(el);
            });
        } catch (e) {
            latestFeedbackEl.innerHTML = '<div class="text-red-600">Помилка завантаження відгуків</div>';
            console.error(e);
        }
    }

    async function doSearch(q) {
        if (!q) return;
        searchResults.classList.remove('hidden');
        resultsGrid.innerHTML = '<div class="col-span-full text-gray-500">Пошук...</div>';
        try {
            const r = await fetch(`${API.products}?q=${encodeURIComponent(q)}`);
            const json = await r.json();
            const items = (json.data && Array.isArray(json.data)) ? json.data : [];
            if (!items.length) {
                resultsGrid.innerHTML = '<div class="col-span-full text-gray-500">Нічого не знайдено</div>';
                return;
            }
            resultsGrid.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded shadow';
                card.innerHTML = `
                    <img src="${item.image || 'https://picsum.photos/seed/'+item.id+'/400/250'}" alt="${item.name}" class="w-full h-36 object-cover rounded mb-2">
                    <h4 class="font-semibold">${item.name}</h4>
                    <p class="text-sm text-gray-600">${item.price ? item.price + ' грн' : 'ціна не вказана'}</p>
                `;
                resultsGrid.appendChild(card);
            });
        } catch (e) {
            resultsGrid.innerHTML = '<div class="col-span-full text-red-600">Помилка пошуку</div>';
            console.error(e);
        }
    }

    searchBtn.addEventListener('click', () => doSearch(searchInput.value.trim()));
    clearBtn.addEventListener('click', () => { searchInput.value = ''; searchResults.classList.add('hidden'); resultsGrid.innerHTML = ''; });
    searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(searchInput.value.trim()); } });

    // initial load
    fetchFeatured();
    fetchLatestFeedback();
});
</script>

{% endblock %}
